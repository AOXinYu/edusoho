webpackJsonp(["app/js/question-bank/testpaper/create/index"],{"33d114f083d38bc5a1d4":function(t,e,a){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}var i=a("6415c664294d747ee392"),n=s(i),o=a("7ab4a89ebadbfdecc2bf"),r=s(o),c=a("4602c3f5fe7ad9e3e91d"),d=s(c),l=a("9181c6995ae8c5c94b7a"),h=a("de585ca0d3c2d0205c51"),u=s(h);a("015a62750c9975765604"),new(function(){function t(e){(0,r.default)(this,t),this.$form=e,this.$description=this.$form.find('[name="description"]'),this.$questionForm=$("#testpaper-items-manager"),this.validator=null,this.difficultySlider=null,this.scoreSlider=null,this.$scoreModal=$(".js-score-modal"),this.$modal=$("#testpaper-confirm-modal"),this.questions=[],this.questionsCount=0,this.$typeNav=this.$form.find("#testpaper-question-nav"),new u.default(this.$questionForm),this._initEvent(),this._initValidate(),this._initScoreValidator(),this._initTypeSort()}return(0,d.default)(t,[{key:"_initEvent",value:function(){var t=this;this.$form.on("click",".js-request-save",function(e){return t._confirmSave(e)}),this.$modal.on("click",".js-confirm-submit",function(e){return t._submitSave(e)}),this.$typeNav.on("click","li",function(e){return t._changeNav(e)}),this.$form.on("click",'[data-role="item-delete-btn"]',function(e){return t.deleteQuestion(e)}),this.$form.on("click",'[data-role="batch-delete-btn"]',function(e){return t.batchDelete(e)}),this.$form.on("click",'[data-role="set-score-btn"]',function(e){return t.showScoreModal(e)}),this.$form.on("click",".js-pick-modal",function(e){return t.showPickModal(e)}),this.$form.on("lengthChange",'[data-role="question-body"]',function(e){return t.changeQuestionCount(e)}),this.$scoreModal.on("click",".js-batch-score-confirm",function(e){return t.batchSetScore(e)}),$(".modal").on("selectQuestion",function(e,a){return t.selectQuestion(e,a)}),this.initSortList()}},{key:"_confirmSave",value:function(){var t=this._validateScore();if(this.validator.form()&&t){this.questionsCount=0,this.questions=[];var e=this._calTestpaperStats(),a="";$.each(e,function(t,e){var s="<tr>";s+="<td>"+e.name+"</td>",s+="<td>"+e.count+"</td>",s+="<td>"+e.score.toFixed(1)+"</td>",s+="</tr>",a+=s}),this.$modal.find(".detail-tbody").html(a),this.$modal.modal("show")}}},{key:"_calTestpaperStats",value:function(){var t={},e=this;this.$typeNav.find("li").each(function(){var a=$(this).find("a").data("type"),s=$(this).find("a").data("name");t[a]={name:s,count:0,score:0,missScore:0},e.$questionForm.find("#testpaper-table-"+a).find(".js-question-score").each(function(){var s=$(this).closest("tr").data("type"),i="material"===s?0:parseFloat($(this).attr("data-score")),n={};"material"!==s&&t[a].count++,t[a].score+=i;var o=0;$(this).next(".js-miss-score").length>0&&(o=parseFloat($(this).next(".js-miss-score").data("missScore"))),t[a].missScore=o,n.id=$(this).closest("tr").data("id"),n.score=i,n.missScore=o,n.type=a,e.questions.push(n)})});var a={name:Translator.trans("activity.testpaper_manage.question_total_score"),count:0,score:0};return $.each(t,function(t,e){a.count+=e.count,a.score+=e.score}),t.total=a,e.questionsCount=a.count,t}},{key:"_validateScore",value:function(){var t=!0;return 0===this.$form.find(".js-question-score").length&&(cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.question_required_error_hint")}),t=!1),this.$form.find(".js-question-score").each(function(){var e=$(this).closest("tr").data("type"),a=$(this).data("score");"0"==a&&"material"!==e&&(cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.question_score_empty_hint")}),t=!1),/^(([1-9]{1}\d{0,2})|([0]{1}))(\.(\d){1})?$/.test(a)||(cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.question_score_error_hint")}),t=!1)}),t}},{key:"_changeNav",value:function(t){var e=$(t.currentTarget),a=e.children().data("type");this.currentType=a,this.$typeNav.find("li").removeClass("active"),e.addClass("active"),this.$form.find(".js-question-table").addClass("hide"),this.$form.find("#testpaper-table-"+a).removeClass("hide"),this.$form.find('[data-role="batch-select"]').prop("checked",!1),this.$form.find('[data-role="batch-item"]').prop("checked",!1)}},{key:"deleteQuestion",value:function(t){t.stopPropagation();var e=$(t.currentTarget),a=e.closest("tr").data("id"),s=e.closest("tbody");s.find('[data-parent-id="'+a+'"]').remove(),e.closest("tr").remove(),s.trigger("lengthChange"),this.refreshSeqs()}},{key:"batchDelete",value:function(t){var e=$(t.currentTarget),a=e.parents(".js-question-table").find("tbody"),s=this;this.$form.find('[data-role="batch-item"]:checked').each(function(){var t=$(this).val();"material"===$(this).closest("tr").data("type")&&s.$form.find('[data-parent-id="'+t+'"]').remove(),$(this).closest("tr").remove()}),a.trigger("lengthChange")}},{key:"showScoreModal",value:function(t){var e=this.$form.find('[data-role="batch-item"]:checked');if(e.length>0){var a=this,s=["choice","uncertain_choice"];e.each(function(){var t=a.$scoreModal.find(".js-miss-score-field");-1!==$.inArray($(this).closest("tr").data("type"),s)?t.removeClass("hidden"):t.addClass("hidden")}),this.$scoreModal.modal("show")}}},{key:"batchSetScore",value:function(t){if(this.scoreValidator.form()){var e=this.$scoreModal.find('input[name="score"]'),a=this.$scoreModal.find('input[name="missScore"]'),s={score:parseFloat(e.val()),missScore:""==a.val()?0:parseFloat(a.val())},i=this;this.$form.find('[data-role="batch-item"]:checked').each(function(){i.setScore($(this).parents("tr"),s)}),cd.message({type:"success",message:Translator.trans("subject.score_update_success")}),this.$scoreModal.modal("hide"),e.val(""),a.val("")}}},{key:"setScore",value:function(t,e){var a=t.find(".js-question-score");if(a.text(e.score),a.attr("data-score",e.score),t.find(".js-miss-score").length>0){var s=t.find(".js-miss-score");s.text(e.missScore),s.attr("data-miss-score",e.missScore)}}},{key:"refreshSeqs",value:function(){var t=1;this.$form.find("tbody tr").each(function(){var e=$(this);e.hasClass("have-sub-questions")||(e.find("td.seq").html(t),t++)}),this.$form.find('[name="questionLength"]').val(t-1>0?t-1:null)}},{key:"changeQuestionCount",value:function(t){var e=$(t.currentTarget),a=e.data("type"),s=0;s="material"===a?e.find("tr.is-sub-question").length:e.find("tr").length,$(".js-count-"+a).html("("+s+")")}},{key:"showPickModal",value:function(t){var e=[],a=$(t.currentTarget);this.$form.find('[name="questionIds[]"]').each(function(){e.push($(this).val())});var s=$("#modal").modal();$.get(a.data("url"),{excludeIds:e.join(",")},function(t){s.html(t)})}},{key:"selectQuestion",value:function(t,e){var a=this.$form.find(".js-pick-modal").data("pickUrl"),s=this;$.post(a,{typeQuestions:e},function(t){t&&$.each(t,function(t,e){var a=s.$questionForm.find("#testpaper-table-"+t).find(".testpaper-table-tbody");a.append(e),a.trigger("lengthChange"),s._refreshSeqs(t)})})}},{key:"_refreshSeqs",value:function(t){var e=1,a=this.$form.find("#testpaper-table-"+t);a.find("tbody tr").each(function(t,a){var s=$(a);s.hasClass("have-sub-questions")||(s.find("td.seq").html(e),e++)}),a.find('[name="questionLength"]').val(e-1>0?e-1:null)}},{key:"_initEditor",value:function(t){var e=this;if(this.$description.length>0){var a=CKEDITOR.replace(this.$description.attr("id"),{toolbar:"Simple",fileSingleSizeLimit:app.fileSingleSizeLimit,filebrowserImageUploadUrl:this.$description.data("imageUploadUrl"),height:100});a.on("change",function(){e.$description.val((0,l.delHtmlTag)(a.getData()))}),a.on("blur",function(){e.$description.val((0,l.delHtmlTag)(a.getData())),t.form()})}}},{key:"_initValidate",value:function(){this.validator=this.$form.validate({rules:{name:{required:!0,maxlength:50,trim:!0},description:{maxlength:500,trim:!0}},messages:{name:{required:Translator.trans("activity.testpaper_manage.input_title_hint"),maxlength:Translator.trans("site.maxlength_hint",{length:50})},description:{required:Translator.trans("activity.testpaper_manage.input_description_hint"),maxlength:Translator.trans("site.maxlength_hint",{length:500})}}}),this._initEditor(this.validator)}},{key:"_initScoreValidator",value:function(){this.scoreValidator=$("#batch-set-score-form").validate({onkeyup:!1,rules:{score:{required:!0,max:999,min:0,es_score:!0},missScore:{required:!1,max:999,min:0,noMoreThan:"#score",es_score:!0}},messages:{missScore:{noMoreThan:Translator.trans("subject.miss_score_no_more_than_score")}}}),$.validator.addMethod("noMoreThan",function(t,e,a){return""==t||parseFloat(t)<=parseFloat($(a).val())},"Please enter a lesser value.")}},{key:"_submitSave",value:function(t){var e=$(t.currentTarget);if(this.questionsCount>2e3)return void cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.questions_length_hint")});var a=[];$("input[name='questionTypeSeq']").each(function(){a.push($(this).val())}),e.button("loading").addClass("disabled");var s={name:this.$form.find("#name-field").val(),description:this.$form.find("#description-field").val()},i={questions:(0,n.default)(this.questions),questionTypeSeq:(0,n.default)(a)};$.post(this.$form.data("url"),{baseInfo:s,questionInfo:i},function(t){t.goto&&(window.location.href=t.goto)})}},{key:"_initTypeSort",value:function(){var t=void 0;$("#testpaper-question-nav").sortable({handle:".js-move-icon",itemSelector:".question-type-table",placeholder:'<li class="question-type-table question-type-placehoder"></li>',onDrop:function(t,e,a,s){t.removeClass("dragged").removeAttr("style"),$("body").removeClass("dragging")},onDragStart:function(e,a,s){var i=e.offset(),n=a.rootGroup.pointer;t={left:n.left-i.left,top:n.top-i.top},s(e,a)},onDrag:function(e,a){var s=e.height(),i=e.width();e.css({left:a.left-t.left,top:a.top-t.top}),$(".question-type-placehoder").css({height:s,width:i})}})}},{key:"initSortList",value:function(){var t=this,e=void 0,a=this.$form.find("tbody"),s=a.hasClass("js-homework-table")?"":"<td></td>",i='<tr class="question-placehoder js-placehoder"><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'+s+"</tr>";a.sortable({containerPath:"> tr",containerSelector:"tbody",itemSelector:"tr.is-question",placeholder:i,exclude:".notMoveHandle",onDragStart:function(t,a,s){t.hasClass("have-sub-questions")||$(".js-have-sub").removeClass("is-question");var i=t.offset(),n=a.rootGroup.pointer;e={left:n.left-i.left,top:n.top-i.top},s(t,a)},onDrag:function(t,a){var s=t.height();t.css({left:a.left-e.left,top:a.top-e.top}),$(".js-placehoder").css({height:s})},onDrop:function(e,a,s){if(s(e,a),e.hasClass("have-sub-questions")){var i=e.parents("tbody");i.find("tr.is-question").each(function(){var t=$(this);i.find("[data-parent-id="+t.data("id")+"]").detach().insertAfter(t)})}else $(".js-have-sub").addClass("is-question");t.refreshSeqs()}})}}]),t}())($("#testpaper-form"))}},["33d114f083d38bc5a1d4"]);